#!/usr/bin/env bash
# qrun-setup  â€•  â€œquick runâ€ ç”¨ã®æ—¢å®šã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦ç™»éŒ²
#
#   ä½¿ã„æ–¹:
#     qrun-setup [<image-tag>]
#
#       â€¢ <image-tag> ã‚’çœç•¥ã™ã‚‹ã¨ qrun-default:latest ãŒä½¿ã‚ã‚Œã¾ã™
#       â€¢ Dockerfile ã¯ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨åŒã˜ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç½®ãã“ã¨
#
set -euo pipefail

# --- å®šæ•° ---------------------------------------------------------------
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DEFAULT_TAG="qrun-default:latest"         # çœç•¥æ™‚ã«ä½¿ã†ã‚¿ã‚°
CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/qrun"
IMAGE_TAG="${1:-$DEFAULT_TAG}"            # 1 å¼•æ•°ç›®ãŒã‚ã‚Œã°ã‚¿ã‚°ã«æ¡ç”¨

# Dockerfile ã®å­˜åœ¨ç¢ºèª
if [[ ! -f "$SCRIPT_DIR/Dockerfile" ]]; then
  echo "âŒ  $SCRIPT_DIR ã« Dockerfile ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚" >&2
  exit 1
fi

echo "ğŸ”¨  Building image '$IMAGE_TAG' from $SCRIPT_DIR/Dockerfile ..."
docker build -t "$IMAGE_TAG" "$SCRIPT_DIR"

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¿ã‚°ã‚’æ›¸ãè¾¼ã¿
mkdir -p "$CONFIG_DIR"
echo "$IMAGE_TAG" > "$CONFIG_DIR/image_tag"

echo "âœ…  ãƒ“ãƒ«ãƒ‰å®Œäº†: $IMAGE_TAG"
echo "   ä»Šå¾Œ qrun ã¯ã“ã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’æ—¢å®šã¨ã—ã¦ä½¿ç”¨ã—ã¾ã™ã€‚"
